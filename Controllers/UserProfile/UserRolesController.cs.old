using Azure.Core;
using Azure.Identity;
using Microsoft.ApplicationInsights;
using Microsoft.ApplicationInsights.DataContracts;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Graph;
using Microsoft.Graph.Models;
using Microsoft.Graph.Models.ODataErrors;
using Microsoft.Identity.Abstractions;
using Microsoft.Identity.Web;
using System.Data;
using System.Dynamic;
using System.Net.Http.Headers;
using System.Runtime.CompilerServices;
using System.Text.Json;
using woodgrovedemo.Helpers;
using woodgrovedemo.Models;

namespace woodgrovedemo.Controllers;

[Authorize]
[ApiController]
[Route("api/[controller]")]
public class UserRolesController : ControllerBase
{
    // Dependency injection
    private readonly IConfiguration _configuration;
    private TelemetryClient _telemetry;

    public UserRolesController(IConfiguration configuration, TelemetryClient telemetry)
    {
        _configuration = configuration;
        _telemetry = telemetry;
    }

    private async Task<UserRoles> GetUserRolesAndGroups()
    {
        var userRoles = new UserRoles();
        var userObjectId = User.GetObjectId();

        // Get the user unique identifier
        if (string.IsNullOrEmpty(userObjectId))
        {
            userRoles.ErrorMessage = "User Object ID not found in token claims.";
            return userRoles;
        }

        var graphClient = MsalAccessTokenHandler.GetGraphClient(_configuration);

        // Get the user's security groups
        var groups = await graphClient.Users[userObjectId].MemberOf.GetAsync();

        // Check if the user is a member of the commercial accounts security proup
        if (groups?.Value != null)
        {
            foreach (var group in groups.Value.OfType<Group>())
            {
                if (group.Id == _configuration["AppRoles:CommercialAccountsSecurityGroup"])
                {
                    userRoles.MemberOfCommercialAccounts = true;
                    break;
                }
            }
        }

        // Get the user's app role assignments
        var appRoleAssignments = await graphClient.Users[userObjectId].AppRoleAssignments.GetAsync();

        // Check if the user has any app role assignments
        if (appRoleAssignments?.Value != null)
        {
            foreach (var appRoleAssignment in appRoleAssignments.Value)
            {
                var roleId = appRoleAssignment.AppRoleId?.ToString();
                // Check the Products.Contributor role
                if (roleId == _configuration["AppRoles:ProductsContributor"])
                {
                    userRoles.HasProductsContributorRole = true;
                    userRoles.ProductsContributorAssignmentId = appRoleAssignment.Id?.ToString() ?? string.Empty;
                }

                // Check the Orders.Manager role
                if (roleId == _configuration["AppRoles:OrdersManager"])
                {
                    userRoles.HasOrdersManagerRole = true;
                    userRoles.OrdersManagerRoleAssignmentId = role.Id?.ToString() ?? string.Empty;
                }
            }
        }

        return userRoles;
    }


    [HttpGet]
    public async Task<IActionResult> GetAsync()
    {

        var userRoles = new UserRoles();
        try
        {
            userRoles = await GetUserRolesAndGroups();
        }
        catch (ODataError odataError)
        {
            userRoles.ErrorMessage = $"Can't read the profile due to the following error: {odataError.Error!.Message} Error code: {odataError.Error.Code}";
            AppInsights.TrackException(_telemetry, odataError, "GetRolesAndGroupsAsync");
        }
        catch (Exception ex)
        {
            string error = ex.InnerException == null ? ex.Message : ex.InnerException.Message;
            userRoles.ErrorMessage = $"Can't read the profile due to the following error: {error}";
            AppInsights.TrackException(_telemetry, ex, "GetRolesAndGroupsAsync");
        }

        return Ok(userRoles);
    }

    [HttpPost]
    public async Task<IActionResult> OnPostAsync([FromForm] UserRoles requestUserRoles)
    {

        var userRoles = new UserRoles();
        // Get the user unique identifier
        var userObjectId = User.GetObjectId();

        if (string.IsNullOrEmpty(userObjectId))
        {
            userRoles.ErrorMessage = "The account cannot be updated since your access token doesn't contain the required 'objectidentifier' claim.";
            return Ok(userRoles);
        }

        try
        {
            var graphClient = MsalAccessTokenHandler.GetGraphClient(this._configuration);
            var commercialGroupId = _configuration["AppRoles:CommercialAccountsSecurityGroup"];

            // Get current app role assignments and groups
            userRoles = await GetUserRolesAndGroups();

            // Check whether to add or remove
            if (userRoles.MemberOfCommercialAccounts && !requestUserRoles.MemberOfCommercialAccounts)
            {
                // Remove the security group 
                await graphClient.Groups[_configuration.GetSection("AppRoles:CommercialAccountsSecurityGroup").Value].Members[userObjectId].Ref.DeleteAsync();
                userRoles.MemberOfCommercialAccounts = false;
            }
            else if (!userRoles.MemberOfCommercialAccounts && requestUserRoles.MemberOfCommercialAccounts)
            {
                await graphClient.Groups[commercialGroupId].Members.Ref.PostAsync(new ReferenceCreate
                {
                    OdataId = $"https://graph.microsoft.com/v1.0/directoryObjects/{userObjectId}"
                });
                userRoles.MemberOfCommercialAccounts = true;
            }

            if (userRoles.HasOrdersManagerRole && !requestUserRoles.HasOrdersManagerRole)
            {
                // Remove the Orders.Manager application role
                await graphClient.Users[userObjectId].AppRoleAssignments[userRoles.OrdersManagerRoleAssignmentId].DeleteAsync();
                userRoles.HasOrdersManagerRole = false;
            }
            else if (!userRoles.HasOrdersManagerRole && requestUserRoles.HasOrdersManagerRole)
            {
                await graphClient.Users[userObjectId].AppRoleAssignments.PostAsync(new AppRoleAssignment
                {
                    PrincipalId = Guid.Parse(userObjectId),
                    ResourceId = Guid.Parse(_configuration["AppRoles:PrincipalId"]!),
                    AppRoleId = Guid.Parse(_configuration["AppRoles:OrdersManager"]!)
                });
                userRoles.HasOrdersManagerRole = true;
            }


            if (userRoles.HasProductsContributorRole == true && requestUserRoles.HasProductsContributorRole == false)
            {
                // Remove the Products.Contributor application role
                await graphClient.Users[userObjectId].AppRoleAssignments[userRoles.ProductsContributorAssignmentId].DeleteAsync();
                userRoles.HasProductsContributorRole = false;
            }
            else if (userRoles.HasProductsContributorRole == false && requestUserRoles.HasProductsContributorRole == true)
            {
                // Add the Products.Contributor application role 
                var requestBody = new AppRoleAssignment
                {
                    PrincipalId = Guid.Parse(userObjectId!),
                    ResourceId = Guid.Parse(_configuration.GetSection("AppRoles:PrincipalId")!.Value!),
                    AppRoleId = Guid.Parse(_configuration.GetSection("AppRoles:ProductsContributor")!.Value!)
                };
                var result = await graphClient.Users[userObjectId].AppRoleAssignments.PostAsync(requestBody);
                userRoles.HasProductsContributorRole = true;
            }
        }
        catch (ODataError odataError)
        {
            userRoles.ErrorMessage = $"Can't read the profile due to the following error: {odataError.Error!.Message} Error code: {odataError.Error.Code}";
            AppInsights.TrackException(_telemetry, odataError, "OnPostRolesAsync");
        }
        catch (Exception ex)
        {
            string error = ex.InnerException == null ? ex.Message : ex.InnerException.Message;
            userRoles.ErrorMessage = $"Can't read the profile due to the following error: {error}";
            AppInsights.TrackException(_telemetry, ex, "OnPostRolesAsync");
        }

        return Ok(userRoles);
    }
}
